<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë©”ì´ë“œ ì¹´í˜ â¤ï¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Jua&display=swap" rel="stylesheet">
    <style>
        :root { 
            --main-pink: #ff80ab; 
            --dark-pink: #d81b60; 
            --light-pink: #ffe4f0; 
            --bg-color: #fff0f5; 
            --shadow: 0 4px 12px rgba(216, 27, 96, 0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Jua', sans-serif; 
            background-color: var(--bg-color);
            background-image: radial-gradient(#ffc1e3 15%, transparent 16%), radial-gradient(#ffc1e3 15%, transparent 16%);
            background-size: 20px 20px; background-position: 0 0, 10px 10px;
            padding: 20px 15px 140px 15px; 
            text-align: center; color: #444; margin: 0;
        }

        /* íƒ€ì´í‹€ */
        h2 { font-size: 26px; color: var(--dark-pink); margin: 45px 0 5px 0; text-shadow: 2px 2px 0px #fff; }
        p.subtitle { 
            font-family: 'Gaegu', cursive; font-size: 16px; color: #666; 
            background: rgba(255,255,255,0.8); padding: 6px 15px; border-radius: 20px; 
            display: inline-block; margin-bottom: 20px; 
        }
        
        /* ë©”ì´ë“œ í˜¸ì¶œ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨ ê³ ì •) */
        .call-maid-btn {
            position: fixed; top: 15px; right: 15px; z-index: 1000;
            background: #ff9800; color: white; border: 2px solid #fff;
            padding: 8px 16px; border-radius: 25px;
            font-family: 'Jua', sans-serif; font-size: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
            transition: transform 0.1s;
        }
        .call-maid-btn:active { transform: scale(0.95); }

        /* í…Œì´ë¸” ë²ˆí˜¸ ì…ë ¥ */
        .table-input-box { 
            background: white; padding: 12px 20px; border-radius: 20px; 
            display: inline-flex; align-items: center; gap: 10px; 
            box-shadow: var(--shadow); border: 3px solid var(--light-pink); 
            margin-bottom: 25px; width: 100%; max-width: 350px; justify-content: center;
        }
        .table-input-box label { font-size: 18px; color: var(--dark-pink); white-space: nowrap; }
        
        input[type="number"] { 
            font-family: 'Jua', sans-serif; font-size: 20px; padding: 8px; width: 80px; 
            text-align: center; border: 2px solid var(--main-pink); border-radius: 12px; 
            color: var(--dark-pink); outline: none; background: #fffbfd;
        }
        /* QR ì ‘ì† ì‹œ ì ê¸ˆ ìŠ¤íƒ€ì¼ */
        input[readonly] { background: #eee; color: #888; border-color: #ccc; }

        /* ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ */
        .menu-container { display: flex; flex-direction: column; gap: 15px; max-width: 500px; margin: 0 auto; }
        
        .menu-item { 
            background: #fff; border: 2px dashed var(--main-pink); border-radius: 20px; 
            padding: 18px; display: flex; flex-direction: column; 
            align-items: flex-start; text-align: left; 
            box-shadow: var(--shadow); position: relative;
        }

        .menu-name { font-size: 18px; color: #333; margin-bottom: 6px; line-height: 1.35; word-break: keep-all; }
        .price-tag { background-color: var(--light-pink); color: var(--dark-pink); padding: 4px 10px; border-radius: 8px; font-size: 13px; font-weight: bold; }
        
        /* ì¬ê³  ìƒíƒœ í‘œì‹œ */
        .stock-status { font-size: 13px; margin-top: 5px; min-height: 18px; }

        /* ìˆ˜ëŸ‰ ì¡°ì ˆ ë²„íŠ¼ */
        .controls { 
            display: flex; align-items: center; gap: 15px; align-self: flex-end; margin-top: 12px; 
            background: #fdf2f7; padding: 6px 8px; border-radius: 30px; 
        }
        .btn-count { 
            width: 38px; height: 38px; border-radius: 50%; border: none; 
            font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-minus { background: #fff; color: #888; border: 1px solid #eee; }
        .btn-plus { background: var(--main-pink); color: white; }
        .count-display { font-size: 22px; font-weight: bold; width: 24px; text-align: center; color: #333; }
        
        /* í’ˆì ˆ ì‹œ ìŠ¤íƒ€ì¼ */
        .sold-out .menu-name { color: #aaa; text-decoration: line-through; }
        .sold-out .controls { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .sold-out .price-tag { background: #eee; color: #999; }

        /* ì¥ë°”êµ¬ë‹ˆ í•˜ë‹¨ ë°” */
        #cartBar { 
            position: fixed; bottom: 20px; left: 15px; right: 15px; margin: 0 auto; max-width: 500px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 25px; border: 2px solid var(--main-pink); 
            box-shadow: 0 10px 30px rgba(216, 27, 96, 0.4); 
            display: flex; flex-direction: column; gap: 12px; z-index: 999;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }

        /* ìš”ì²­ì‚¬í•­ ë©”ëª¨ì¥ */
        #requestNote { 
            width: 100%; padding: 12px; border: 1px solid #e0e0e0; 
            border-radius: 12px; font-family: 'Gaegu', cursive; font-size: 16px; 
            background: #f9f9f9; resize: none; 
        }
        #requestNote:focus { outline: none; border-color: var(--main-pink); background: #fff; }

        .cart-top { display: flex; justify-content: space-between; align-items: center; }
        #totalCount { font-size: 17px; color: var(--dark-pink); font-weight: bold; }
        
        #orderBtn { 
            background: linear-gradient(135deg, #ff80ab, #d81b60); color: white; border: none; padding: 12px 24px; 
            font-family: 'Jua', sans-serif; font-size: 18px; border-radius: 20px; cursor: pointer; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(216, 27, 96, 0.3);
        }
    </style>
</head>
<body>

    <button class="call-maid-btn" onclick="callMaid()">ğŸ”” ë©”ì´ë“œ í˜¸ì¶œ</button>

    <h2>ğŸ€ ë©”ì´ë“œ ì¹´í˜ ì£¼ë¬¸ ğŸ€</h2>
    <p class="subtitle">ì£¼ì¸ë‹˜ì„ ìœ„í•œ ì‹¤ì‹œê°„ ë©”ë‰´íŒ âœ¨</p>
    
    <div class="table-input-box">
        <label>Table No.</label>
        <input type="number" id="tableNo" placeholder="?" inputmode="numeric" min="1" max="25">
    </div>

    <div id="menuList" class="menu-container">
        <!-- ë©”ë‰´ê°€ ë¡œë”©ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        <div style="padding:20px;">ë¡œë”©ì¤‘... ğŸª</div>
    </div>

    <div id="cartBar" style="display:none;">
        <textarea id="requestNote" rows="1" placeholder="ìš”ì²­ì‚¬í•­ (ì˜ˆ: ì´ˆì½”íŒŒì´ ë¶€ìˆ´ì„œ ì£¼ì„¸ìš”!!)"></textarea>
        <div class="cart-top">
            <span id="totalCount">ì´ 0ê°œ ì„ íƒ</span>
            <button id="orderBtn" onclick="sendOrder()">ì£¼ë¬¸í•˜ê¸° â¤ï¸</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, runTransaction, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5lLY7p09aqglYrqYEF6hBBRxIOaB59Uk",
            authDomain: "madecafe-85738.firebaseapp.com",
            projectId: "madecafe-85738",
            storageBucket: "madecafe-85738.firebasestorage.app",
            messagingSenderId: "481793894590",
            appId: "1:481793894590:web:00873d3f6285c87d6756ef",
            measurementId: "G-HVE60ZL3XZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ë©”ë‰´ IDëŠ” ì¬ê³  ê´€ë¦¬ì í˜ì´ì§€(manager.html)ì˜ ì´ˆê¸°í™”ëœ IDì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
        const menus = [
            { id: 1, name: "ì´ˆì½”íŒŒì´ë¥¼ ê³ ë°±ìš©ìœ¼ë¡œ ì“°ì§€ ë§ì•„ì£¼ì„¸ìš” ì œë°œ ğŸ˜¢", limit: 2 },
            { id: 2, name: "ì£¼ì¸ë‹˜ ì˜¤ëŠ˜ì€ ë ˆëª¬ë•…ì˜ ì¶•ë³µì„! ë©”ì§€ì»¬ ì—.ì´.ë“œ. ğŸ‹", limit: 2 },
            { id: 3, name: "ë§ˆì‹œë©´ ê¸°ë¶„ì´ Highí•´ì§€ëŠ” ë©”ì´ë“œì§±ì˜ ì˜ë¬¸ì˜ ëŸ¬ë¸”ë¦¬ ì•¡ì²´ë“¤ ğŸ§ª", limit: 2 },
            { id: 4, name: "ê°•ëƒ‰ì´ë¥¼ ë°”ë¼ë³´ì ê°•ëƒ‰ì´ê°€ ë‚˜ë¥¼ ì‘ì‹œí–ˆë‹¤ ğŸ‘€", limit: 2 },
            { id: 5, name: "ë‘ê·¼ë‘ê·¼ ë£°ë › (ê±°ë¶€ê¶Œ ì—†ìŒ! ì¢‹ì€ ê±¸ì§€ë„..?) ğŸŠ", limit: 1 },
            { id: 6, name: "ë©”ì´ë“œì§±ì˜ ìŠ¤í˜ì…œ ì„œë¹„ìŠ¤ íƒ€ì„ê³¼ ì• êµ? ğŸ˜³", limit: 999 }
        ];

        let cart = {}; 
        let inventoryStatus = {}; // ì‹¤ì‹œê°„ ì¬ê³  ì •ë³´ ì €ì¥ìš©

        // [ì´ˆê¸°í™”] QRì½”ë“œ ì²´í¬ ë° ì¬ê³  ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tableParam = urlParams.get('table');
            
            if(tableParam) {
                const tableNum = parseInt(tableParam);
                if(tableNum >= 1 && tableNum <= 25) {
                    const tableInput = document.getElementById('tableNo');
                    tableInput.value = tableNum;
                    tableInput.readOnly = true; 
                } else {
                    alert("QRì½”ë“œ ì˜¤ë¥˜: í…Œì´ë¸” ë²ˆí˜¸ëŠ” 1~25ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                }
            }
            
            // 1. ìš°ì„  ë©”ë‰´ í™”ë©´ ê·¸ë¦¬ê¸°
            renderMenu();

            // 2. ì‹¤ì‹œê°„ ì¬ê³ (inventory) ê°ì‹œ ì‹œì‘
            onSnapshot(collection(db, "inventory"), (snapshot) => {
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const menuId = docSnap.id; // ë¬¸ì„œ IDê°€ ë©”ë‰´ IDì„
                    
                    inventoryStatus[menuId] = data.count; // ì¬ê³  ìˆ˜ëŸ‰ ì €ì¥
                    
                    updateStockUI(menuId, data.count);
                });
            });
        };

        // ì¬ê³  ìƒíƒœì— ë”°ë¼ UI ì—…ë°ì´íŠ¸ (í’ˆì ˆ ì²˜ë¦¬ ë“±)
        function updateStockUI(id, count) {
            const statusEl = document.getElementById(`stock-msg-${id}`);
            const itemEl = document.getElementById(`menu-item-${id}`);
            
            if(!statusEl || !itemEl) return;

            // 1. í’ˆì ˆ (0ê°œ ì´í•˜)
            if(count <= 0) {
                statusEl.innerHTML = "<span style='color:red; font-weight:bold;'>â›” í’ˆì ˆ (Sold Out)</span>";
                itemEl.classList.add('sold-out');
                // ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¨ìˆì—ˆë‹¤ë©´ ê°•ì œ ì œê±°
                if(cart[id]) {
                    delete cart[id];
                    document.getElementById(`cnt-${id}`).innerText = 0;
                    updateTotal();
                }
            } 
            // 2. ë§ˆê° ì„ë°• (5ê°œ ë¯¸ë§Œ)
            else if(count < 5) {
                statusEl.innerHTML = `<span style='color:#d81b60; font-weight:bold;'>âš¡ ë§ˆê°ì„ë°•! (${count}ê°œ ë‚¨ìŒ)</span>`;
                itemEl.classList.remove('sold-out');
            } 
            // 3. ë„‰ë„‰í•¨
            else {
                statusEl.innerHTML = "";
                itemEl.classList.remove('sold-out');
            }
        }

        function checkTableNumber() {
            const tableNo = document.getElementById('tableNo').value;
            if(!tableNo) {
                alert("ì£¼ì¸ë‹˜! í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì…”ì•¼ í•´ìš”! ğŸ’¦");
                return false;
            }
            if(tableNo < 1 || tableNo > 25) {
                alert("í…Œì´ë¸” ë²ˆí˜¸ëŠ” 1ë²ˆë¶€í„° 25ë²ˆê¹Œì§€ë§Œ ê°€ëŠ¥í•´ìš”! â¤ï¸");
                return false;
            }
            return true;
        }

        window.callMaid = async () => {
            if(!checkTableNumber()) return;
            const tableNo = document.getElementById('tableNo').value;

            if(confirm(`[Table ${tableNo}] ë©”ì´ë“œë¥¼ í˜¸ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ğŸ””`)) {
                try {
                    await addDoc(collection(db, "orders"), {
                        table: tableNo,
                        type: 'call',
                        status: "í˜¸ì¶œ",
                        time: serverTimestamp()
                    });
                    alert("ë©”ì´ë“œë‹˜ì´ ê³§ ë‹¬ë ¤ê°‘ë‹ˆë‹¤! ğŸƒâ€â™€ï¸ğŸ’¨");
                } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
            }
        }

        function renderMenu() {
            const container = document.getElementById('menuList');
            container.innerHTML = menus.map(menu => `
                <div class="menu-item" id="menu-item-${menu.id}">
                    <div class="menu-name">${menu.name}</div>
                    <div class="stock-status" id="stock-msg-${menu.id}"></div>
                    <div class="price-tag">Free ${menu.limit < 10 ? `<span style="font-weight:normal;opacity:0.8;font-size:12px;">(ìµœëŒ€ ${menu.limit}ê°œ)</span>` : ''}</div>
                    <div class="controls">
                        <button class="btn-count btn-minus" onclick="changeCount(${menu.id}, -1)">âˆ’</button>
                        <span class="count-display" id="cnt-${menu.id}">0</span>
                        <button class="btn-count btn-plus" onclick="changeCount(${menu.id}, 1)">ï¼‹</button>
                    </div>
                </div>
            `).join('');
        }

        window.changeCount = (id, delta) => {
            const menu = menus.find(m => m.id === id);
            const currentQty = cart[id] || 0;
            const newQty = currentQty + delta;
            
            // í˜„ì¬ ì¬ê³  í™•ì¸
            const stock = inventoryStatus[String(id)] ?? 999; // ì •ë³´ ì—†ìœ¼ë©´ 999ë¡œ ê°€ì •(ë¡œë”©ì „)

            if (newQty < 0) return;
            
            // 1. ê°œì¸ ì œí•œ ì²´í¬
            if (newQty > menu.limit) {
                if (menu.id === 5) alert("ë£°ë ›ì€ 1ë²ˆë§Œ ëŒë¦´ ìˆ˜ ìˆì–´ìš”! (ìš´ëª…ì€ í•œ ë²ˆë¿..âœ¨)");
                else alert(`ì´ ë©”ë‰´ëŠ” ìµœëŒ€ ${menu.limit}ê°œê¹Œì§€ë§Œ ê°€ëŠ¥í•´ìš”! ğŸ˜¢`);
                return;
            }

            // 2. ì¬ê³  ìˆ˜ëŸ‰ ì²´í¬ (í™”ë©´ìƒ)
            if (newQty > stock) {
                alert(`ì•—! ë‚¨ì€ ì¬ê³ ê°€ ${stock}ê°œ ë¿ì´ì—ìš” ğŸ’¦`);
                return;
            }

            if (newQty === 0) delete cart[id];
            else cart[id] = newQty;
            
            document.getElementById(`cnt-${id}`).innerText = newQty;
            updateTotal();
        }

        function updateTotal() {
            const total = Object.values(cart).reduce((a, b) => a + b, 0);
            document.getElementById('totalCount').innerText = `ì´ ${total}ê°œ`;
            const cartBar = document.getElementById('cartBar');
            cartBar.style.display = total > 0 ? 'flex' : 'none';
        }

        // [ì£¼ë¬¸í•˜ê¸°] íŠ¸ëœì­ì…˜ ì‚¬ìš©: ì¬ê³  í™•ì¸ -> ì°¨ê° -> ì£¼ë¬¸ ìƒì„±ì„ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬
        window.sendOrder = async () => {
            if(!checkTableNumber()) return; 
            const tableNo = document.getElementById('tableNo').value;
            const note = document.getElementById('requestNote').value; 
            const total = Object.values(cart).reduce((a, b) => a + b, 0);

            if(total === 0) return alert("ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”! â¤ï¸");

            if(confirm(`ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì¬ê³ ê°€ ì¦‰ì‹œ ì°¨ê°ë©ë‹ˆë‹¤) â¤ï¸`)) {
                try {
                    await runTransaction(db, async (transaction) => {
                        const orderMenuNames = [];

                        // 1. ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ëª¨ë“  ë©”ë‰´ì˜ ì¬ê³  ë¬¸ì„œ ì½ê¸°
                        for (const [id, qty] of Object.entries(cart)) {
                            const stockRef = doc(db, "inventory", String(id));
                            const stockDoc = await transaction.get(stockRef);

                            if (!stockDoc.exists()) {
                                throw "ì˜¤ë¥˜: í•´ë‹¹ ë©”ë‰´ì˜ ì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                            }

                            const currentStock = stockDoc.data().count;
                            const menuName = menus.find(m => m.id == id).name;

                            // 2. ì¬ê³  ê²€ì¦
                            if (currentStock < qty) {
                                throw `[${menuName}] ì¬ê³  ë¶€ì¡±! (ë‚¨ì€ ìˆ˜ëŸ‰: ${currentStock}ê°œ)`;
                            }

                            // 3. ì¬ê³  ì°¨ê° ì˜ˆì•½
                            transaction.update(stockRef, { count: currentStock - qty });
                            
                            // ì£¼ë¬¸ì„œ ë‚´ìš© ìƒì„±
                            orderMenuNames.push(`${menuName} x${qty}`);
                        }

                        // 4. ì£¼ë¬¸ì„œ ìƒì„± ì˜ˆì•½
                        const newOrderRef = doc(collection(db, "orders"));
                        transaction.set(newOrderRef, {
                            table: tableNo,
                            menu: orderMenuNames,
                            note: note, 
                            type: 'order',
                            status: "ì ‘ìˆ˜",
                            time: serverTimestamp()
                        });
                    });

                    alert("ì£¼ë¬¸ ì ‘ìˆ˜ ì™„ë£Œ! ë§›ìˆê²Œ ë§Œë“¤ì–´ë“œë¦´ê²Œìš” â¤ï¸");
                    location.reload(); 

                } catch (e) {
                    console.error(e);
                    // ê°ì²´ ì—ëŸ¬ë©´ ë©”ì‹œì§€ë§Œ ì¶”ì¶œ, ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì¶œë ¥
                    const msg = typeof e === 'object' ? e.message : e;
                    alert("ì£¼ë¬¸ ì‹¤íŒ¨ ğŸ˜¢: " + msg);
                }
            }
        }
    </script>
</body>
</html>
